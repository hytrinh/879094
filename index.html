<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>进度跟踪系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Tối ưu bảng */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table, th, td {
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      padding: 12px;
      font-size: 18px;
    }

    td {
      padding: 12px;
      background-color: #fafafa;
      font-size: 16px;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #eaeaea;
    }

    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }

    button.delete {
      background-color: #f44336;
    }

    button.delete:hover {
      background-color: #e53935;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    @media only screen and (max-width: 768px) {
      table, th, td, input[type="text"], input[type="number"], select {
        font-size: 14px;
      }

      button {
        width: 100%;
        font-size: 18px;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-family: Arial, sans-serif;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
      background-color: #f9f9f9;
    }

    input[type="text"]:hover, input[type="number"]:hover, select:hover {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
<script>
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
        (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
      alert("操作已被禁用！");
      return false;
    }
  });

  function sendWebhook(message) {
    fetch("URL_WEBHOOK", {
      method: "POST",
      body: JSON.stringify({ content: message }),
      headers: { "Content-Type": "application/json" },
    })
    .then(response => response.text())
    .then(data => console.log("Webhook response:", data))
    .catch(error => console.error("Error sending webhook:", error));
  }
</script>
<div id="loginContainer">
  <h2>系统登录</h2>
  <label for="usernameInput">用户名：</label>
  <input type="text" id="usernameInput" placeholder="请输入用户名" />
  <label for="viewPassword">密码：</label>
  <input type="password" id="viewPassword" placeholder="请输入密码" />
  <button onclick="checkViewPassword()">登录</button>
</div>
<div id="mainContainer" style="display:none;">
  <div class="toolbar">
    用户名：<span id="displayName"></span>
    <button onclick="requireEditPassword()">启用编辑权限</button>
    <button onclick="addRow()">➕ 添加一行</button>
    <button onclick="saveData()">💾 保存</button>
    <input id="searchInput" onkeyup="searchTable()" placeholder="🔍 搜索...">
  </div>
  <table id="detailTable">
    <thead>
      <tr>
        <th>单号</th><th>内容</th><th>分类</th><th>负责人</th><th>部门</th>
        <th>开单日</th><th>接单日</th><th>状态</th><th>进度(%)</th>
        <th>总天数</th><th>完成日</th><th>原因</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>📊 汇总表</h3>
  <div id="summaryTable"></div>
  <h3>📌 未完成原因统计</h3>
  <div id="reasonTable"></div>
</div>
<script>
  const viewPass = "zz251298";
  const editPass = "aa879094";
  let canEdit = false;
  let currentUser = "";
  const webhookURL = "https://script.google.com/macros/s/AKfycbzxqN1aRvPzWnDWPyLOaDZkD3THCbWIIPqe-2G6B0zkpvkGmE959DreF1w3hq8pQMhFEg/exec";
  const correctPassword = "zz251298";

  function checkViewPassword() {
    const password = document.getElementById("viewPassword").value;
    const username = document.getElementById("usernameInput").value.trim();
    if (password === correctPassword) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.getElementById("displayName").innerText = username || "匿名";
      loadData();
      sendLoginInfo(username);
    } else {
      alert("密码错误，请重新输入！");
    }
  }
  function sendLoginInfo(user) {
    const data = {
      user: user,
      time: new Date(),
      action: "Đăng nhập hệ thống"
    };

    fetch("https://script.google.com/macros/s/AKfycbzxqN1aRvPzWnDWPyLOaDZkD3THCbWIIPqe-2G6B0zkpvkGmE959DreF1w3hq8pQMhFEg/exec", {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" },
    })
    .then(res => res.text())
    .then(response => {
      console.log("📨 登录记录已发送:", response);
    })
    .catch(err => console.error("❌ 登录记录发送失败:", err));
  }
</script>
<script>
 // 编辑权限
 function requireEditPassword() {
   const pw = prompt("请输入编辑密码：");
   if (pw === editPass) {
     canEdit = true;
     alert("编辑权限已启用");
   } else {
     alert("密码错误，无法编辑");
     sendWebhook(`${currentUser} 尝试启用编辑失败`);
   }
 }
 
 // 发送 webhook 记录行为
 
 // 添加一行
 function addRow() {
   if (!canEdit) {
     alert("请先输入编辑密码");
     sendWebhook(`${currentUser} 尝试添加行但无权限`);
     return;
   }
   
   const tbody = document.querySelector("#detailTable tbody");
   const row = tbody.insertRow();
   
   // Thêm các ô dữ liệu
   for (let i = 0; i < 12; i++) {
     const cell = row.insertCell();
     const input = document.createElement("input");
     input.type = i === 8 ? "number" : "text"; // Kiểu ô số cho tiến độ
     input.oninput = updateSummary; // Đảm bảo gọi update mỗi khi có thay đổi
     cell.appendChild(input);
   }
 }
 
 // 保存数据
 function saveData() {
  if (!canEdit) {
    alert("请先输入编辑密码");
    sendWebhook(`${currentUser} 尝试保存数据但无权限`);
    return;
  }

  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const data = rows.map(r =>
    Array.from(r.cells).map(c => c.firstChild?.value || "")
  );

  // Gửi dữ liệu đến Google Script
  fetch("https://script.google.com/macros/s/AKfycbzxqN1aRvPzWnDWPyLOaDZkD3THCbWIIPqe-2G6B0zkpvkGmE959DreF1w3hq8pQMhFEg/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then(res => res.text())
    .then(response => {
      if (response === "OK") {
        alert("✅ 儲存成功！");
      } else {
        alert("⚠️ 發生錯誤：" + response);
      }
    })
    .catch(err => {
      console.error("錯誤:", err);
      alert("❌ 儲存失敗，請稍後再試");
    });
}

 
 // 加载数据
 function loadData() {
  const storedData = localStorage.getItem("details");
  if (storedData) {
    const data = JSON.parse(storedData);
    const tableBody = document.querySelector("#detailTable tbody");

     // Đảm bảo bảng sạch trước khi thêm dữ liệu mới
     tableBody.innerHTML = "";
 
     // Thêm dữ liệu vào bảng
     data.forEach(rowData => {
      const row = tableBody.insertRow();
      rowData.forEach(cellData => {
        const cell = row.insertCell();
        const input = document.createElement("input");
        input.type = "text";
        input.value = cellData;
        input.oninput = updateSummary; // Đảm bảo gọi update mỗi khi có thay đổi
        cell.appendChild(input);
      });
    });
    updateSummary(); // Cập nhật bảng tổng hợp sau khi tải dữ liệu
  } else {
    console.log("没有保存的数据。");
    // Có thể hiển thị thông báo nếu không có dữ liệu
  }
}
 
 // 更新汇总
 function updateSummary() {
  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const groupRanges = [
    { label: "0-10天", min: 0, max: 10 },
    { label: "11-30天", min: 11, max: 30 },
    { label: "31-60天", min: 31, max: 60 },
    { label: "61-180天", min: 61, max: 180 },
    { label: "180天以上", min: 181, max: Infinity },
  ];

  const summary = {};
  rows.forEach(row => {
    const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
    const [ , , category, , , , receiveDate, , progressStr] = cells;
    const progress = parseInt(progressStr) || 0;

    const dayCount = calculateDayCount(receiveDate); // Tính số ngày đã qua từ ngày nhận
    const range = groupRanges.find(r => dayCount >= r.min && dayCount <= r.max)?.label || "未知";
    if (!summary[range]) summary[range] = { RWT: { 完成: 0, 未完成: 0 }, MIT: { 完成: 0, 未完成: 0 } };
    if (category === "RWT") {
      summary[range].RWT[progress === 100 ? "完成" : "未完成"]++;
    } else if (category === "MIT") {
      summary[range].MIT[progress === 100 ? "完成" : "未完成"]++;
    }

    const dayCell = row.cells[9];
    if (dayCell && dayCount) dayCell.firstChild.value = dayCount;
  });

  renderSummaryTable(summary);
  renderReasonTable(); // Hiển thị bảng thống kê
}
function renderSummaryTable(data) {
   let html = `<table><tr><th>范围</th><th>RWT完成</th><th>RWT未完成</th><th>MIT完成</th><th>MIT未完成</th></tr>`;
   const total = { RWT完成: 0, RWT未完成: 0, MIT完成: 0, MIT未完成: 0 };
   Object.keys(data).forEach(range => {
     const r = data[range];
     html += `<tr><td>${range}</td><td>${r.RWT.完成}</td><td>${r.RWT.未完成}</td><td>${r.MIT.完成}</td><td>${r.MIT.未完成}</td></tr>`;
     total.RWT完成 += r.RWT.完成;
     total.RWT未完成 += r.RWT.未完成;
     total.MIT完成 += r.MIT.完成;
     total.MIT未完成 += r.MIT.未完成;
   });
   html += `<tr><td><b>总计</b></td><td><b>${total.RWT完成}</b></td><td><b>${total.RWT未完成}</b></td><td><b>${total.MIT完成}</b></td><td><b>${total.MIT未完成}</b></td></tr>`;
   html += `</table>`;
   document.getElementById("summaryTable").innerHTML = html;
}
function renderReasonTable(data) {
  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const reasonCount = {};

  rows.forEach(row => {
    const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
    const reason = cells[11]; // 第12列：原因
    const progress = parseInt(cells[8]) || 0;

    if (progress < 100 && reason.trim() !== "") {
      if (!reasonCount[reason]) reasonCount[reason] = 0;
      reasonCount[reason]++;
    }
  });

  let html = `<table><tr><th>未完成原因</th><th>数量</th></tr>`;
  Object.entries(reasonCount).forEach(([key, value]) => {
    html += `<tr><td>${key}</td><td>${value}</td></tr>`;
  });
  html += `</table>`;

  document.getElementById("reasonTable").innerHTML = html;
}
function calculateDayCount(receiveDate) {
  const today = new Date();
  const receiveDateObj = new Date(receiveDate);
  const diffTime = today - receiveDateObj;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}
window.onload = function () {
  fetch("https://script.google.com/macros/s/AKfycbzxqN1aRvPzWnDWPyLOaDZkD3THCbWIIPqe-2G6B0zkpvkGmE959DreF1w3hq8pQMhFEg/exec")
    .then(response => response.json())
    .then(data => {
      const tbody = document.querySelector("#detailTable tbody");
      data.slice(1).forEach(row => {
        const tr = tbody.insertRow();
        row.forEach((val, i) => {
          const cell = tr.insertCell();
          const input = document.createElement("input");
          input.type = i === 8 ? "number" : "text";
          input.value = val || "";
          input.oninput = updateSummary;
          cell.appendChild(input);
        });
      });
      updateSummary();
      renderReasonTable(data); // Sửa lại ở đây để truyền 'data'
    });
};
function saveToGoogleSheet(data) {
  fetch("https://script.google.com/macros/s/AKfycbzxqN1aRvPzWnDWPyLOaDZkD3THCbWIIPqe-2G6B0zkpvkGmE959DreF1w3hq8pQMhFEg/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  }).then(res => alert("已儲存成功！"));
}
 
 </script>
 </body>
 </html>