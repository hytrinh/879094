<!DOCTYPE html>
 <html lang="zh">
 <head>
   <meta charset="UTF-8">
   <title>è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ</title>
   <title>Biá»ƒu Ä‘á»“ trÃ²n</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
   <style>
     body { font-family: Arial; background: #f5f5f5; padding: 20px; }
     table, th, td { border: 1px solid #ccc; border-collapse: collapse; }
     table { width: 100%; margin-top: 10px; background: white; }
     th, td { padding: 6px; text-align: center; }
     .toolbar input, .toolbar button { margin-right: 5px; padding: 5px; }
     .toolbar { margin-bottom: 10px; }
     .hidden { display: none; }
   </style>
 </head>
 <body>
  <script>
    // ç¦ç”¨å³é”®èœå•
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });
    
    // ç¦ç”¨ F12ã€Ctrl+Shift+Iã€Ctrl+U
    document.addEventListener('keydown', function (e) {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || 
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        alert("æ“ä½œå·²è¢«ç¦ç”¨ï¼");
        return false;
      }
    });
    </script>
 <!-- ç™»å½•ç•Œé¢ -->
 <div id="loginContainer">
   <h2>ğŸ” ç™»å½•ç³»ç»Ÿ</h2>
   <input type="text" id="usernameInput" placeholder="è¾“å…¥å§“å (å¯è‡ªå®šä¹‰)">
   <input type="password" id="viewPassword" placeholder="æŸ¥çœ‹å¯†ç ">
   <button onclick="checkViewPassword()">è¿›å…¥ç³»ç»Ÿ</button>
 </div>
 <script>
 function sendWebhook(message) {
   fetch("URL_WEBHOOK", {
     method: "POST",
     body: JSON.stringify({ content: message }),
     headers: { "Content-Type": "application/json" },
   })
   .then(response => response.text())
   .then(data => console.log("Webhook response:", data))
   .catch(error => console.error("Error sending webhook:", error));
 }
   </script>
 <!-- ä¸»ç•Œé¢ -->
 <div id="mainContainer" class="hidden">
   <div class="toolbar">
     ç”¨æˆ·åï¼š<span id="displayName"></span>
     <button onclick="requireEditPassword()">å¯ç”¨ç¼–è¾‘æƒé™</button>
     <button onclick="addRow()">â• æ·»åŠ ä¸€è¡Œ</button>
     <button onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
     <input id="searchInput" onkeyup="searchTable()" placeholder="ğŸ” æœç´¢...">
   </div>
 
   <table id="detailTable">
     <thead>
       <tr>
         <th>å•å·</th><th>å†…å®¹</th><th>åˆ†ç±»</th><th>è´Ÿè´£äºº</th><th>éƒ¨é—¨</th>
         <th>å¼€å•æ—¥</th><th>æ¥å•æ—¥</th><th>çŠ¶æ€</th><th>è¿›åº¦(%)</th>
         <th>æ€»å¤©æ•°</th><th>å®Œæˆæ—¥</th><th>åŸå› </th>
       </tr>
     </thead>
     <tbody></tbody>
   </table>
 
   <h3>ğŸ“Š æ±‡æ€»è¡¨</h3>
   <div id="summaryTable"></div>
   <h3>ğŸ“Œ æœªå®ŒæˆåŸå› ç»Ÿè®¡</h3>
   <div id="reasonTable"></div>
   <h3>ğŸ“ˆ åœ†å½¢å›¾</h3>
   <canvas id="pieChart" width="300" height="300"></canvas>
 
 </div>
 
 <script>
 const viewPass = "zz251298"; // Máº­t kháº©u xem
 const editPass = "aa879094"; // Máº­t kháº©u chá»‰nh sá»­a
 let canEdit = false;         // Quyá»n chá»‰nh sá»­a
 let currentUser = "";        // NgÆ°á»i dÃ¹ng hiá»‡n táº¡i
 const webhookURL = "https://script.google.com/macros/s/AKfycbxDOPRL00uvFxhQS2pYo8fBMAq-1dhu7Os5e51U6pkOu2KwEZoZPZdFuotyf9qXQO4gSA/exec"; // URL webhook
 
 // ç™»å½•éªŒè¯
 function checkViewPassword() {
   const name = document.getElementById("usernameInput").value.trim();
   const pass = document.getElementById("viewPassword").value;
   if (pass === viewPass) {
     currentUser = name || "åŒ¿å";
     document.getElementById("displayName").innerText = currentUser;
     document.getElementById("loginContainer").classList.add("hidden");
     document.getElementById("mainContainer").classList.remove("hidden");
     loadData();
     updateSummary(); // Initial update
     
     // Gá»­i thÃ´ng tin Ä‘Äƒng nháº­p tá»›i Google Sheets
     sendLoginInfo(currentUser);
   } else {
     alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•è¿›å…¥ã€‚");
   }
 }
 function sendLoginInfo(user) {
   const data = {
     user: user,
     time: new Date(),
     action: "ÄÄƒng nháº­p há»‡ thá»‘ng"
   };
 
   fetch(webhookURL, {
     method: "POST",
     headers: {
       "Content-Type": "application/json"
     },
     body: JSON.stringify(data) // Chuyá»ƒn dá»¯ liá»‡u thÃ nh chuá»—i JSON
   })
   .then(response => response.text())
   .then(data => console.log("Success:", data))
   .catch(error => console.error("Error:", error));
 }
 
 // ç¼–è¾‘æƒé™
 function requireEditPassword() {
   const pw = prompt("è¯·è¾“å…¥ç¼–è¾‘å¯†ç ï¼š");
   if (pw === editPass) {
     canEdit = true;
     alert("ç¼–è¾‘æƒé™å·²å¯ç”¨");
   } else {
     alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•ç¼–è¾‘");
     sendWebhook(`${currentUser} å°è¯•å¯ç”¨ç¼–è¾‘å¤±è´¥`);
   }
 }
 
 // å‘é€ webhook è®°å½•è¡Œä¸º
 
 // æ·»åŠ ä¸€è¡Œ
 function addRow() {
   if (!canEdit) {
     alert("è¯·å…ˆè¾“å…¥ç¼–è¾‘å¯†ç ");
     sendWebhook(`${currentUser} å°è¯•æ·»åŠ è¡Œä½†æ— æƒé™`);
     return;
   }
   
   const tbody = document.querySelector("#detailTable tbody");
   const row = tbody.insertRow();
   
   // ThÃªm cÃ¡c Ã´ dá»¯ liá»‡u
   for (let i = 0; i < 12; i++) {
     const cell = row.insertCell();
     const input = document.createElement("input");
     input.type = i === 8 ? "number" : "text"; // Kiá»ƒu Ã´ sá»‘ cho tiáº¿n Ä‘á»™
     input.oninput = updateSummary; // Äáº£m báº£o gá»i update má»—i khi cÃ³ thay Ä‘á»•i
     cell.appendChild(input);
   }
 }
 
 // ä¿å­˜æ•°æ®
 function saveData() {
  if (!canEdit) {
    alert("è¯·å…ˆè¾“å…¥ç¼–è¾‘å¯†ç ");
    sendWebhook(`${currentUser} å°è¯•ä¿å­˜æ•°æ®ä½†æ— æƒé™`);
    return;
  }

  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const data = rows.map(r =>
    Array.from(r.cells).map(c => c.firstChild?.value || "")
  );

  // Gá»­i dá»¯ liá»‡u Ä‘áº¿n Google Script
  fetch("https://script.google.com/macros/s/AKfycbxDOPRL00uvFxhQS2pYo8fBMAq-1dhu7Os5e51U6pkOu2KwEZoZPZdFuotyf9qXQO4gSA/exec", {
    method: "POST",
    body: JSON.stringify(data),
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then(res => res.text())
    .then(response => {
      if (response === "OK") {
        alert("âœ… å„²å­˜æˆåŠŸï¼");
      } else {
        alert("âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + response);
      }
    })
    .catch(err => {
      console.error("éŒ¯èª¤:", err);
      alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    });
}

 
 // åŠ è½½æ•°æ®
 function loadData() {
   const storedData = localStorage.getItem("details");
   if (storedData) {
     const data = JSON.parse(storedData);
     const tableBody = document.querySelector("#detailTable tbody");
 
     // Äáº£m báº£o báº£ng sáº¡ch trÆ°á»›c khi thÃªm dá»¯ liá»‡u má»›i
     tableBody.innerHTML = "";
 
     // ThÃªm dá»¯ liá»‡u vÃ o báº£ng
     data.forEach(rowData => {
       const row = tableBody.insertRow();
       rowData.forEach(cellData => {
         const cell = row.insertCell();
         const input = document.createElement("input");
         input.type = "text";
         input.value = cellData;
         input.oninput = updateSummary; // Äáº£m báº£o gá»i update má»—i khi cÃ³ thay Ä‘á»•i
         cell.appendChild(input);
       });
     });
   } else {
     console.log("æ²¡æœ‰ä¿å­˜çš„æ•°æ®ã€‚");
     // CÃ³ thá»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u
   }
 }
 
 // æ›´æ–°æ±‡æ€»
 function updateSummary() {
   const rows = Array.from(document.querySelector("#detailTable tbody").rows);
   const groupRanges = [
     { label: "0-10å¤©", min: 0, max: 10 },
     { label: "11-30å¤©", min: 11, max: 30 },
     { label: "31-60å¤©", min: 31, max: 60 },
     { label: "61-180å¤©", min: 61, max: 180 },
     { label: "180å¤©ä»¥ä¸Š", min: 181, max: Infinity },
   ];
 
   const summary = {};
   const reasonStats = { RWT: { "é‡‡è´­ä¸­": 0, "å‘åŒ…ä¸­": 0, "æ‰§è¡Œä¸­": 0, "ç¡®è®¤ä¸­": 0 }, MIT: { "é‡‡è´­ä¸­": 0, "å‘åŒ…ä¸­": 0, "æ‰§è¡Œä¸­": 0, "ç¡®è®¤ä¸­": 0 } };
   const today = new Date();
 
   rows.forEach(row => {
     const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
     const [ , , category, , , , receiveDate, , progressStr, status, finishDate ] = cells;
     const type = category.toUpperCase().includes("MIT") ? "MIT" : "RWT";
     const progress = parseInt(progressStr) || 0;
     const done = progress === 100;
     const dateRcv = receiveDate ? new Date(receiveDate) : null;
     const dateFin = finishDate ? new Date(finishDate) : null;
 
     let dayCount = 0;
     if (dateRcv) {
       dayCount = done && dateFin ? Math.floor((dateFin - dateRcv) / (1000 * 60 * 60 * 24)) : Math.floor((today - dateRcv) / (1000 * 60 * 60 * 24));
     }
 
     const range = groupRanges.find(r => dayCount >= r.min && dayCount <= r.max)?.label || "æœªçŸ¥";
     if (!summary[range]) summary[range] = { RWT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 }, MIT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 } };
     summary[range][type][done ? "å®Œæˆ" : "æœªå®Œæˆ"]++;
 
     const dayCell = row.cells[9];
     if (dayCell && dateRcv) dayCell.firstChild.value = dayCount;
 
     // Cáº­p nháº­t lÃ½ do chÆ°a hoÃ n thÃ nh dá»±a trÃªn tráº¡ng thÃ¡i vÃ  tiáº¿n Ä‘á»™
     updateReasonSummary(reasonStats, {è¿›åº¦: progress, çŠ¶æ€: status, åˆ†ç±»: type, åŸå› : row.cells[11].firstChild?.value});
   });
 
   renderSummaryTable(summary);
   renderReasonTable(reasonStats); // Cáº­p nháº­t báº£ng lÃ½ do
   drawChart(summary);  // Cáº­p nháº­t biá»ƒu Ä‘á»“
}
function renderSummaryTable(data) {
   let html = `<table><tr><th>èŒƒå›´</th><th>RWTå®Œæˆ</th><th>RWTæœªå®Œæˆ</th><th>MITå®Œæˆ</th><th>MITæœªå®Œæˆ</th></tr>`;
   const total = { RWTå®Œæˆ: 0, RWTæœªå®Œæˆ: 0, MITå®Œæˆ: 0, MITæœªå®Œæˆ: 0 };
   Object.keys(data).forEach(range => {
     const r = data[range];
     html += `<tr><td>${range}</td><td>${r.RWT.å®Œæˆ}</td><td>${r.RWT.æœªå®Œæˆ}</td><td>${r.MIT.å®Œæˆ}</td><td>${r.MIT.æœªå®Œæˆ}</td></tr>`;
     total.RWTå®Œæˆ += r.RWT.å®Œæˆ;
     total.RWTæœªå®Œæˆ += r.RWT.æœªå®Œæˆ;
     total.MITå®Œæˆ += r.MIT.å®Œæˆ;
     total.MITæœªå®Œæˆ += r.MIT.æœªå®Œæˆ;
   });
   html += `<tr><td><b>æ€»è®¡</b></td><td><b>${total.RWTå®Œæˆ}</b></td><td><b>${total.RWTæœªå®Œæˆ}</b></td><td><b>${total.MITå®Œæˆ}</b></td><td><b>${total.MITæœªå®Œæˆ}</b></td></tr>`;
   html += `</table>`;
   document.getElementById("summaryTable").innerHTML = html;
}
 
 function renderReasonTable(data) {
  const statuses = ["é‡‡è´­ä¸­", "å‘åŒ…ä¸­", "æ‰§è¡Œä¸­", "ç¡®è®¤ä¸­"];
  let html = `<table><tr><th>åˆ†ç±»</th>${statuses.map(r => `<th>${r}</th>`).join("")}</tr>`;

  for (const type in data) {
    html += `<tr><td>${type}</td>${statuses.map(s => `<td>${data[type][s] || 0}</td>`).join("")}</tr>`;
  }

  html += `</table>`;
  document.getElementById("reasonTable").innerHTML = html;
}
function updateReasonSummary(summary, rowData) {
   const progress = rowData['è¿›åº¦']; // Láº¥y tiáº¿n Ä‘á»™
   const status = rowData['çŠ¶æ€']; // Láº¥y tráº¡ng thÃ¡i
   const type = rowData['åˆ†ç±»']; // RWT/MIT

   // Náº¿u tiáº¿n Ä‘á»™ khÃ´ng pháº£i 100% vÃ  tráº¡ng thÃ¡i khÃ´ng pháº£i å·²å®Œæˆ
   if (progress !== 100 && status !== "å·²å®Œæˆ") {
     const reason = rowData['åŸå› ']; // LÃ½ do chÆ°a hoÃ n thÃ nh

     // Cáº­p nháº­t lÃ½ do vÃ o báº£ng summary
     if (!summary[type]) summary[type] = {};
     if (!summary[type][reason]) summary[type][reason] = 0;
     summary[type][reason] += 1;
   }
}
 function drawPieChart() {
     const table = document.getElementById("summaryTable");
     const rows = table.rows;
     
     // Dá»¯ liá»‡u cho biá»ƒu Ä‘á»“
     const categories = [];  // Loáº¡i Ä‘Æ¡n
     const progress = [];    // Tiáº¿n Ä‘á»™
 
     // Duyá»‡t qua cÃ¡c hÃ ng cá»§a báº£ng Ä‘á»ƒ láº¥y dá»¯ liá»‡u
     for (let i = 1; i < rows.length; i++) {
       categories.push(rows[i].cells[0].innerText);  // Loáº¡i Ä‘Æ¡n (RWT, MIT)
       progress.push(parseInt(rows[i].cells[2].innerText));  // Tiáº¿n Ä‘á»™
     }
 
     // Truy cáº­p pháº§n tá»­ canvas vÃ  táº¡o context
     const canvas = document.getElementById("pieChart");
     const ctx = canvas.getContext("2d");
 
     // TÃ­nh toÃ¡n tá»•ng tiáº¿n Ä‘á»™
     const totalProgress = progress.reduce((a, b) => a + b, 0);
 
     // Táº¡o cÃ¡c mÃ u sáº¯c cho cÃ¡c pháº§n cá»§a biá»ƒu Ä‘á»“ trÃ²n
     const colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A8'];
 
     // XoÃ¡ biá»ƒu Ä‘á»“ cÅ©
     ctx.clearRect(0, 0, canvas.width, canvas.height);
 
     // Váº½ biá»ƒu Ä‘á»“ trÃ²n
     let startAngle = 0;
     for (let i = 0; i < progress.length; i++) {
       const sliceAngle = (progress[i] / totalProgress) * (Math.PI * 2); // TÃ­nh gÃ³c pháº§n tá»­
 
       // Váº½ pháº§n cáº¯t cá»§a biá»ƒu Ä‘á»“ trÃ²n
       ctx.beginPath();
       ctx.arc(50, 40, 15, startAngle, startAngle + sliceAngle); // Váº½ pháº§n trÃ²n
       ctx.lineTo(50, 40); // Váº½ Ä‘Æ°á»ng tháº³ng tá»« Ä‘iá»ƒm giá»¯a
       ctx.fillStyle = colors[i % colors.length]; // Chá»n mÃ u sáº¯c (Ä‘áº£m báº£o vÃ²ng láº¡i mÃ u khi cÃ³ nhiá»u pháº§n)
       ctx.fill();
 
       // Cáº­p nháº­t gÃ³c báº¯t Ä‘áº§u cho pháº§n tiáº¿p theo
       startAngle += sliceAngle;
 
       // Ghi chÃº tÃªn vÃ  tiáº¿n Ä‘á»™ lÃªn biá»ƒu Ä‘á»“
       ctx.fillStyle = '#000000';
       ctx.fillText(categories[i] + ": " + progress[i] + "%", 250 + Math.cos(startAngle - sliceAngle / 2) * 160, 200 + Math.sin(startAngle - sliceAngle / 2) * 160);
     }
   }
 
 // Váº½ láº¡i biá»ƒu Ä‘á»“ má»—i khi báº£ng chi tiáº¿t thay Ä‘á»•i
 function drawChart(summary) {
   const ctx = document.getElementById('pieChart').getContext('2d');
   const categories = Object.keys(summary);

   // Dá»¯ liá»‡u biá»ƒu Ä‘á»“
   const rwtCompleted = categories.map(category => summary[category].RWT["å®Œæˆ"]);
   const rwtNotCompleted = categories.map(category => summary[category].RWT["æœªå®Œæˆ"]);
   const mitCompleted = categories.map(category => summary[category].MIT["å®Œæˆ"]);
   const mitNotCompleted = categories.map(category => summary[category].MIT["æœªå®Œæˆ"]);

   // Dá»¯ liá»‡u biá»ƒu Ä‘á»“ trÃ²n
   const chartData = {
     labels: categories,
     datasets: [{
       label: 'RWT å®Œæˆ',
       data: rwtCompleted,
       backgroundColor: '#FF5733',
     }, {
       label: 'RWT æœªå®Œæˆ',
       data: rwtNotCompleted,
       backgroundColor: '#FFBD33',
     }, {
       label: 'MIT å®Œæˆ',
       data: mitCompleted,
       backgroundColor: '#33FF57',
     }, {
       label: 'MIT æœªå®Œæˆ',
       data: mitNotCompleted,
       backgroundColor: '#3357FF',
     }]
   };

   // TÃ¹y chá»‰nh biá»ƒu Ä‘á»“ trÃ²n
   const chartOptions = {
     responsive: true,
     plugins: {
       legend: {
         position: 'top',
       },
       tooltip: {
         callbacks: {
           label: function(tooltipItem) {
             return `${tooltipItem.dataset.label}: ${tooltipItem.raw}`;
           }
         }
       }
     }
   };

   // Táº¡o biá»ƒu Ä‘á»“
   new Chart(ctx, {
     type: 'pie',
     data: chartData,
     options: chartOptions
   });
  }
    function drawPieChart() {
      const summary = JSON.parse(localStorage.getItem("summary"));
      if (summary) {
        drawChart(summary);
      } else {
        console.log("No summary data found to draw the chart.");
      }
    }
 
 drawPieChart();
 function searchTable() {
   const input = document.getElementById("searchInput").value.toLowerCase();
   const rows = document.querySelectorAll("#detailTable tbody tr");
   rows.forEach(row => {
     const cells = Array.from(row.cells);
     const matches = cells.some(cell => cell.textContent.toLowerCase().includes(input));
     row.style.display = matches ? "" : "none";
   });
 }
 window.onload = function () {
       const savedUser = localStorage.getItem("loggedUser");
       if (savedUser) {
         currentUser = savedUser;
         showMain();
       }
     };
 
 </script>
 </body>
 </html>