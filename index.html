<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="script.js?v=1.0"></script>
  <style>
    /* Tá»‘i Æ°u báº£ng */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table, th, td {
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      padding: 12px;
      font-size: 18px;
    }

    td {
      padding: 12px;
      background-color: #fafafa;
      font-size: 16px;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #eaeaea;
    }

    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }

    button.delete {
      background-color: #f44336;
    }

    button.delete:hover {
      background-color: #e53935;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    @media only screen and (max-width: 768px) {
      table, th, td, input[type="text"], input[type="number"], select {
        font-size: 14px;
      }

      button {
        width: 100%;
        font-size: 18px;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-family: Arial, sans-serif;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
      background-color: #f9f9f9;
    }

    input[type="text"]:hover, input[type="number"]:hover, select:hover {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbxQwuVcXlSaac8lrIVJrWSLUS0EKDs6aJhBBdASvp30J7vylNIRsgCOd6FUX0KU4az0uw/exec";
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
        (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
      alert("æ“ä½œå·²è¢«ç¦ç”¨ï¼");
      return false;
    }
  });

  function sendWebhook(message) {
    fetch("URL_WEBHOOK", {
      method: "POST",
      body: JSON.stringify({ content: message }),
      headers: { "Content-Type": "application/json" },
    })
    .then(response => response.text())
    .then(data => console.log("Webhook response:", data))
    .catch(error => console.error("Error sending webhook:", error));
  }
</script>
<div id="loginContainer">
  <h2>ç³»ç»Ÿç™»å½•</h2>
  <label for="usernameInput">ç”¨æˆ·åï¼š</label>
  <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
  <label for="viewPassword">å¯†ç ï¼š</label>
  <input type="password" id="viewPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
  <button onclick="checkViewPassword()">ç™»å½•</button>
</div>
<div id="mainContainer" style="display:none;">
  <div class="toolbar">
    ç”¨æˆ·åï¼š<span id="displayName"></span>
    <button onclick="requireEditPassword()">å¯ç”¨ç¼–è¾‘æƒé™</button>
    <button onclick="addRow()">â• æ·»åŠ ä¸€è¡Œ</button>
    <button onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
    <input id="searchInput" onkeyup="searchTable()" placeholder="ğŸ” æœç´¢...">
  </div>
  <table id="detailTable">
    <thead>
      <tr>
        <th>å•å·</th><th>å†…å®¹</th><th>åˆ†ç±»</th><th>è´Ÿè´£äºº</th><th>éƒ¨é—¨</th>
        <th>å¼€å•æ—¥</th><th>æ¥å•æ—¥</th><th>çŠ¶æ€</th><th>è¿›åº¦(%)</th>
        <th>æ€»å¤©æ•°</th><th>å®Œæˆæ—¥</th><th>åŸå› </th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>ğŸ“Š æ±‡æ€»è¡¨</h3>
  <div id="summaryTable"></div>
  <h3>ğŸ“Œ æœªå®ŒæˆåŸå› ç»Ÿè®¡</h3>
  <div id="reasonTable"></div>
  <div id="totalDays"></div>
</div>
<script>
  const viewPass = "zz2512";
  const editPass = "aa879094";
  let canEdit = false;
  let currentUser = "";

  function checkViewPassword() {
    const password = document.getElementById("viewPassword").value;
    const username = document.getElementById("usernameInput").value.trim();
    if (password === viewPass) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.getElementById("displayName").innerText = username || "åŒ¿å";
      loadData();
      sendLoginInfo(username);
    } else {
      alert("å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
    }
  }
  function sendLoginInfo(user) {
  const data = {
    user: user,
    time: new Date(),
    action: "ÄÄƒng nháº­p há»‡ thá»‘ng"
  };

  try {
    fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(response => {
      console.log("ğŸ“¨ ç™»å½•è®°å½•å·²å‘é€:", response);
    });
  } catch (err) {
    console.error("âŒ ç™»å½•è®°å½•å‘é€å¤±è´¥:", err);
  }
}
  function requireEditPassword() {
    const pw = prompt("è¯·è¾“å…¥ç¼–è¾‘å¯†ç ï¼š");
    if (pw === editPass) {
      canEdit = true;
      alert("ç¼–è¾‘æƒé™å·²å¯ç”¨");
    } else {
      alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•ç¼–è¾‘");
      sendWebhook(`${currentUser} å°è¯•å¯ç”¨ç¼–è¾‘å¤±è´¥`);
    }
  }

  function addRow() {
  if (!canEdit) {
    alert("è¯·å…ˆè¾“å…¥ç¼–è¾‘å¯†ç ");
    sendWebhook(`${currentUser} å°è¯•æ·»åŠ è¡Œä½†æ— æƒé™`);
    return;
  }

  const table = document.querySelector("#detailTable tbody");
  const row = document.createElement("tr");

  // Táº¡o cÃ¡c Ã´ trong hÃ ng má»›i
  for (let i = 0; i < 13; i++) {
    const cell = document.createElement("td");
    const input = document.createElement("input");
    input.type = "text";

    // ThÃªm kiá»ƒu date cho cá»™t "æ¥å•æ—¥" vÃ  "å®Œæˆæ—¥"
    if (i === 6 || i === 10) input.type = "date";

    // Cá»™t "æ€»å¤©æ•°" sáº½ lÃ  readonly
    if (i === 9) {
      input.readOnly = true;
      input.style.backgroundColor = "#f5f5f5";
    }

    // Láº¯ng nghe sá»± kiá»‡n nháº­p liá»‡u
    input.addEventListener("input", () => {
      updateSummary();  // Cáº­p nháº­t láº¡i báº£ng tá»•ng há»£p má»—i khi cÃ³ thay Ä‘á»•i
    });

    cell.appendChild(input);
    row.appendChild(cell);
  }

  table.appendChild(row);
}

function saveData() {
  if (!canEdit) {
    alert("âŒ æ— ç¼–è¾‘æƒé™ï¼Œæ— æ³•ä¿å­˜ï¼");
    sendWebhook(`${currentUser} å°è¯•ä¿å­˜ä½†æ— æƒé™`);
    return;
  }

  const table = document.querySelector("#detailTable tbody");
  const rows = table.querySelectorAll("tr");
  const dataArray = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const rowData = [];
    inputs.forEach(input => {
      rowData.push(input.value.trim());
    });

    if (rowData.some(value => value !== "")) {
      dataArray.push(rowData);
    }
  });

  if (dataArray.length === 0) {
    alert("âš ï¸ æ²¡æœ‰è¦ä¿å­˜çš„æ•°æ®ï¼");
    return;
  }

  fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify({ data: dataArray }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      alert("âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼");
    } else {
      alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + result.message);
    }
  })
  .catch(error => {
  console.warn("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼ˆæš‚æœªä¸Šä¼ ï¼‰", error);
});
}
function loadData() {
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        const tableBody = document.querySelector("#detailTable tbody");
        tableBody.innerHTML = "";

        if (Array.isArray(data)) {
          data.forEach(rowData => {
            const row = tableBody.insertRow();
            rowData.forEach((cellData, i) => {
              const cell = row.insertCell();
              const input = document.createElement("input");

              input.value = cellData;
              input.type = (i === 6 || i === 10) ? "date" : "text";
              if (i === 9) {
                input.readOnly = true;
                input.style.backgroundColor = "#f5f5f5";
              }

              input.addEventListener("input", () => {
                if (i === 6 || i === 10) {
                  const rowInputs = row.querySelectorAll("input");
                  const start = rowInputs[6].value;
                  const end = rowInputs[10].value;
                  rowInputs[9].value = calculateTotalDays(start, end);
                }
              });

              cell.appendChild(input);
            });
          });
        }
      });
  }

 function loadTable() {
            const tbody = document.querySelector("#detailTable tbody");
            tbody.innerHTML = ''; // Clear existing rows

            detailRows.forEach(rowData => {
                const row = document.createElement("tr");
                rowData.forEach(data => {
                    const cell = document.createElement("td");
                    const input = document.createElement("input");
                    input.value = data;
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            // Update summary and reason stats after table load
            updateSummary();
        }
        function calculateTotalDays(startDateStr, endDateStr) {
  if (!startDateStr) return '';
  const startDate = new Date(startDateStr);
  const endDate = endDateStr ? new Date(endDateStr) : new Date();

  const diffTime = endDate.getTime() - startDate.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays > 0 ? diffDays : 0;
}

function updateReasonTable() {
  const rows = document.querySelectorAll("#detailTable tbody tr");
  const reasonCount = {};

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const reason = inputs[11]?.value.trim();
    const status = inputs[7]?.value.trim();
    const endDate = inputs[10]?.value;

    if (!endDate && reason) {
      reasonCount[reason] = (reasonCount[reason] || 0) + 1;
    }
  });

  const reasonTable = document.getElementById("reasonTable");
  let html = "<table><tr><th>åŸå› </th><th>æ¬¡æ•¸</th></tr>";
  Object.entries(reasonCount).forEach(([key, val]) => {
    html += `<tr><td>${key}</td><td>${val}</td></tr>`;
  });
  html += "</table>";
  reasonTable.innerHTML = html;
}

function updateSummaryTable() {
  const rows = document.querySelectorAll("#detailTable tbody tr");
  const statusCount = {};

  rows.forEach(row => {
    const status = row.querySelectorAll("input")[7]?.value.trim();
    if (status) {
      statusCount[status] = (statusCount[status] || 0) + 1;
    }
  });

  const summaryTable = document.getElementById("summaryTable");
  let html = "<table><tr><th>ç‹€æ…‹</th><th>æ¬¡æ•¸</th></tr>";
  Object.entries(statusCount).forEach(([key, val]) => {
    html += `<tr><td>${key}</td><td>${val}</td></tr>`;
  });
  html += "</table>";
  summaryTable.innerHTML = html;
}

function updateSummary() {
  updateReasonTable();
  updateSummaryTable();
}

// TÃ­ch há»£p vÃ o addRow (gá»£i Ã½ Ä‘áº·t láº¡i toÃ n bá»™ addRow náº¿u cáº§n)
function addRow(data = []) {
  const tbody = document.querySelector("#detailTable tbody");
  const row = document.createElement("tr");

  const headers = [
    "å–®è™Ÿ", "å…§å®¹å–®", "åˆ†é¡å–®", "è² è²¬äºº", "éƒ¨é–€",
    "é–‹å–®æ—¥æœŸ", "æ¥å–®æ—¥æœŸ", "ç‹€æ…‹", "é€²åº¦",
    "ç¸½æ—¥æœŸ", "å®Œæˆå–®", "åŸå› "
  ];

  for (let i = 0; i < headers.length; i++) {
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = (i === 5 || i === 6 || i === 10) ? "date" : "text";
    input.value = data[i] || "";

    // Tá»± Ä‘á»™ng tÃ­nh "ç¸½æ—¥æœŸ"
    input.addEventListener("input", () => {
  // Tá»± Ä‘á»™ng cáº­p nháº­t tá»•ng ngÃ y
  if (i === 6 || i === 10) {
    const rowInputs = row.querySelectorAll("input");
    const start = rowInputs[6].value;
    const end = rowInputs[10].value;
    rowInputs[9].value = calculateTotalDays(start, end);
  }
  updateSummary(); // cáº­p nháº­t má»i thá»‘ng kÃª
});
    input.addEventListener("input", () => {
      updateSummary(); // cáº­p nháº­t báº£ng thá»‘ng kÃª khi ngÆ°á»i dÃ¹ng gÃµ
    });

    td.appendChild(input);
    row.appendChild(td);
  }

  const delTd = document.createElement("td");
  const delBtn = document.createElement("button");
  delBtn.textContent = "X";
  delBtn.className = "deleteRow";
  delBtn.onclick = () => {
    row.remove();
    updateSummary();
  };
  delTd.appendChild(delBtn);
  row.appendChild(delTd);

  tbody.appendChild(row);
  updateSummary();
}
function updateTotalDays(row) {
  const inputs = row.querySelectorAll("input");
  const startDate = inputs[6].value;
  const endDate = inputs[10].value;
  const totalDays = calculateTotalDays(startDate, endDate);
  inputs[9].value = totalDays;
}
 function calculateDayCount(receiveDate) {
            const today = new Date();
            const dateReceived = new Date(receiveDate);
            const diffTime = today - dateReceived;
            return Math.floor(diffTime / (1000 * 3600 * 24));
        }

        function updateSummary() {
  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const groupRanges = [
    { label: "0-10å¤©", min: 0, max: 10 },
    { label: "11-30å¤©", min: 11, max: 30 },
    { label: "31-60å¤©", min: 31, max: 60 },
    { label: "61-180å¤©", min: 61, max: 180 },
    { label: "180å¤©ä»¥ä¸Š", min: 181, max: Infinity },
  ];

  const summary = {};
  let totalDays = 0;

  rows.forEach(row => {
    const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
    const category = cells[2]; // Loáº¡i Ä‘Æ¡n
    const receiveDate = cells[6]; // NgÃ y nháº­n Ä‘Æ¡n
    const progress = parseInt(cells[8]) || 0;

    const dayCount = calculateTotalDays(receiveDate, cells[10]);
    totalDays += dayCount;  // Cá»™ng dá»“n tá»•ng sá»‘ ngÃ y

    const range = groupRanges.find(r => dayCount >= r.min && dayCount <= r.max)?.label || "æœªçŸ¥";

    if (!summary[range]) summary[range] = { RWT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 }, MIT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 } };

    const status = progress >= 100 ? "å®Œæˆ" : "æœªå®Œæˆ";

    if (category === "RWT" || category === "MIT") {
      summary[range][category][status]++;
    }
  });

  // Hiá»ƒn thá»‹ báº£ng tá»•ng há»£p
  let html = "<table><thead><tr><th>åˆ†ç»„</th><th>RWTå®Œæˆ</th><th>RWTæœªå®Œæˆ</th><th>MITå®Œæˆ</th><th>MITæœªå®Œæˆ</th></tr></thead><tbody>";
  for (const range in summary) {
    const rwt = summary[range].RWT;
    const mit = summary[range].MIT;
    html += `<tr>
        <td>${range}</td>
        <td>${rwt.å®Œæˆ}</td><td>${rwt.æœªå®Œæˆ}</td>
        <td>${mit.å®Œæˆ}</td><td>${mit.æœªå®Œæˆ}</td>
    </tr>`;
  }
  html += "</tbody></table>";
  document.getElementById("summaryTable").innerHTML = html;

  // Hiá»ƒn thá»‹ tá»•ng sá»‘ ngÃ y
  document.getElementById("totalDays").innerText = "æ€»å¤©æ•°: " + totalDays;

  // Cáº­p nháº­t báº£ng lÃ½ do
  updateReasonStats();
}
       function updateReasonStats() {
            const rows = Array.from(document.querySelector("#detailTable tbody").rows);
            const reasonCount = {
                "é‡‡è´­ä¸­": 0,
                "åœ¨æ‰§è¡Œ": 0,
                "å‘åŒ…ä¸­": 0,
                "åœ¨ç¡®è®¤": 0,
            };

            rows.forEach(row => {
                const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
                const progress = parseInt(cells[8]) || 0;
                const reason = cells[11].trim();

                if (progress < 100 && reason) {
                    if (reasonCount.hasOwnProperty(reason)) {
                        reasonCount[reason]++;
                    }
                }
            });

            let html = "<table><thead><tr><th>åŸå› </th><th>æ•°é‡</th></tr></thead><tbody>";
            for (const reason in reasonCount) {
                html += `<tr><td>${reason}</td><td>${reasonCount[reason]}</td></tr>`;
            }
            html += "</tbody></table>";
            document.getElementById("reasonTable").innerHTML = html;
        }

        // Initial load
        loadTable();
window.onload = function () {
    fetch(scriptURL)
      .then(response => response.json())
      .then(data => {
        const tbody = document.querySelector("#detailTable tbody");
        if (Array.isArray(data)) {
          data.forEach(item => {
            const row = tbody.insertRow();
            item.forEach(val => {
              const cell = row.insertCell();
              const input = document.createElement("input");
              input.type = "text";
              input.value = val;
              input.addEventListener("input", updateSummary);
              cell.appendChild(input);
            });
          });
        }
      });
  };
 </script>
 </body>
 </html>