<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Tá»‘i Æ°u báº£ng */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table, th, td {
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      padding: 12px;
      font-size: 18px;
    }

    td {
      padding: 12px;
      background-color: #fafafa;
      font-size: 16px;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #eaeaea;
    }

    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }

    button.delete {
      background-color: #f44336;
    }

    button.delete:hover {
      background-color: #e53935;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    @media only screen and (max-width: 768px) {
      table, th, td, input[type="text"], input[type="number"], select {
        font-size: 14px;
      }

      button {
        width: 100%;
        font-size: 18px;
      }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-family: Arial, sans-serif;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
      background-color: #f9f9f9;
    }

    input[type="text"]:hover, input[type="number"]:hover, select:hover {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbxgafa_4zDxEPkcK98Inqse3Cu7O9MAKQQVwDPqwknrZdBqSfXshfapzg6DT1xmF-24zA/exec";
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
        (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
      alert("æ“ä½œå·²è¢«ç¦ç”¨ï¼");
      return false;
    }
  });

  function sendWebhook(message) {
    fetch("URL_WEBHOOK", {
      method: "POST",
      body: JSON.stringify({ content: message }),
      headers: { "Content-Type": "application/json" },
    })
    .then(response => response.text())
    .then(data => console.log("Webhook response:", data))
    .catch(error => console.error("Error sending webhook:", error));
  }
</script>
<div id="loginContainer">
  <h2>ç³»ç»Ÿç™»å½•</h2>
  <label for="usernameInput">ç”¨æˆ·åï¼š</label>
  <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
  <label for="viewPassword">å¯†ç ï¼š</label>
  <input type="password" id="viewPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
  <button onclick="checkViewPassword()">ç™»å½•</button>
</div>
<div id="mainContainer" style="display:none;">
  <div class="toolbar">
    ç”¨æˆ·åï¼š<span id="displayName"></span>
    <button onclick="requireEditPassword()">å¯ç”¨ç¼–è¾‘æƒé™</button>
    <button onclick="addRow()">â• æ·»åŠ ä¸€è¡Œ</button>
    <button onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
    <input id="searchInput" onkeyup="searchTable()" placeholder="ğŸ” æœç´¢...">
  </div>
  <table id="detailTable">
    <thead>
      <tr>
        <th>å•å·</th><th>å†…å®¹</th><th>åˆ†ç±»</th><th>è´Ÿè´£äºº</th><th>éƒ¨é—¨</th>
        <th>å¼€å•æ—¥</th><th>æ¥å•æ—¥</th><th>çŠ¶æ€</th><th>è¿›åº¦(%)</th>
        <th>æ€»å¤©æ•°</th><th>å®Œæˆæ—¥</th><th>åŸå› </th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>ğŸ“Š æ±‡æ€»è¡¨</h3>
  <div id="summaryTable"></div>
  <h3>ğŸ“Œ æœªå®ŒæˆåŸå› ç»Ÿè®¡</h3>
  <div id="reasonTable"></div>
</div>
<script>
  const viewPass = "zz2512";
  const editPass = "aa879094";
  let canEdit = false;
  let currentUser = "";
  const webhookURL = "https://script.google.com/macros/s/AKfycbxgafa_4zDxEPkcK98Inqse3Cu7O9MAKQQVwDPqwknrZdBqSfXshfapzg6DT1xmF-24zA/exec";
  const correctPassword = "zz2512";

  function checkViewPassword() {
    const password = document.getElementById("viewPassword").value;
    const username = document.getElementById("usernameInput").value.trim();
    if (password === correctPassword) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("mainContainer").style.display = "block";
      document.getElementById("displayName").innerText = username || "åŒ¿å";
      loadData();
      sendLoginInfo(username);
    } else {
      alert("å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
    }
  }

  function sendLoginInfo(user) {
  const data = {
    user: user,
    time: new Date(),
    action: "ÄÄƒng nháº­p há»‡ thá»‘ng"
  };

  try {
    fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(response => {
      console.log("ğŸ“¨ ç™»å½•è®°å½•å·²å‘é€:", response);
    });
  } catch (err) {
    console.error("âŒ ç™»å½•è®°å½•å‘é€å¤±è´¥:", err);
  }
}

  function requireEditPassword() {
    const pw = prompt("è¯·è¾“å…¥ç¼–è¾‘å¯†ç ï¼š");
    if (pw === editPass) {
      canEdit = true;
      alert("ç¼–è¾‘æƒé™å·²å¯ç”¨");
    } else {
      alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•ç¼–è¾‘");
      sendWebhook(`${currentUser} å°è¯•å¯ç”¨ç¼–è¾‘å¤±è´¥`);
    }
  }

  function addRow() {
    if (!canEdit) {
      alert("è¯·å…ˆè¾“å…¥ç¼–è¾‘å¯†ç ");
      sendWebhook(`${currentUser} å°è¯•æ·»åŠ è¡Œä½†æ— æƒé™`);
      return;
    }

    const tbody = document.querySelector("#detailTable tbody");
    const row = tbody.insertRow();

    // ThÃªm cÃ¡c Ã´ dá»¯ liá»‡u
    for (let i = 0; i < 12; i++) {
      const cell = row.insertCell();
      const input = document.createElement("input");
      input.type = i === 8 ? "number" : "text"; // Kiá»ƒu Ã´ sá»‘ cho tiáº¿n Ä‘á»™
      input.oninput = updateSummary;
      cell.appendChild(input);
    }
  }

  function saveData() {
  if (!canEdit) {
    alert("è¯·å…ˆè¾“å…¥ç¼–è¾‘å¯†ç ");
    sendWebhook(`${currentUser} å°è¯•ä¿å­˜æ•°æ®ä½†æ— æƒé™`); // Sá»­a lá»—i á»Ÿ Ä‘Ã¢y
    return;
  }

  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const data = rows.map(r =>
    Array.from(r.cells).map(c => c.firstChild?.value || "")
  );

  fetch("https://script.google.com/macros/s/AKfycbxDOPRL00uvFxhQS2pYo8fBMAq-1dhu7Os5e51U6pkOu2KwEZoZPZdFuotyf9qXQO4gSA/exec", {
  method: "POST",
  body: JSON.stringify(data),
  headers: {
    "Content-Type": "application/json",
  }
})
.then(res => res.text())
.then(response => {
  if (response === "OK") {
    alert("âœ… å„²å­˜æˆåŠŸï¼");
  } else {
    alert("âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + response);
  }
})
.catch(err => {
  console.error("éŒ¯èª¤:", err);
  alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
});
}
  function loadData() {
  const storedData = localStorage.getItem("details");
  if (storedData) {
    const data = JSON.parse(storedData);
    const tableBody = document.querySelector("#detailTable tbody");

     // Äáº£m báº£o báº£ng sáº¡ch trÆ°á»›c khi thÃªm dá»¯ liá»‡u má»›i
     tableBody.innerHTML = "";
 
     // ThÃªm dá»¯ liá»‡u vÃ o báº£ng
     data.forEach(rowData => {
      const row = tableBody.insertRow();
      rowData.forEach(cellData => {
        const cell = row.insertCell();
        const input = document.createElement("input");
        input.type = "text";
        input.value = cellData;
        input.oninput = updateSummary; // Äáº£m báº£o gá»i update má»—i khi cÃ³ thay Ä‘á»•i
        cell.appendChild(input);
      });
    });
    updateSummary(); // Cáº­p nháº­t báº£ng tá»•ng há»£p sau khi táº£i dá»¯ liá»‡u
  } else {
    console.log("æ²¡æœ‰ä¿å­˜çš„æ•°æ®ã€‚");
    // CÃ³ thá»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u
  }
}


  function searchTable() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#detailTable tbody tr");

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      const match = Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(searchTerm));
      row.style.display = match ? "" : "none";
    });
  }
 // æ›´æ–°æ±‡æ€»
 function updateSummary() {
  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const groupRanges = [
    { label: "0-10å¤©", min: 0, max: 10 },
    { label: "11-30å¤©", min: 11, max: 30 },
    { label: "31-60å¤©", min: 31, max: 60 },
    { label: "61-180å¤©", min: 61, max: 180 },
    { label: "180å¤©ä»¥ä¸Š", min: 181, max: Infinity },
  ];

  const summary = {};
  rows.forEach(row => {
    const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
    const [ , , category, , , , receiveDate, , progressStr] = cells;
    const progress = parseInt(progressStr) || 0;

    const dayCount = calculateDayCount(receiveDate); // TÃ­nh sá»‘ ngÃ y Ä‘Ã£ qua tá»« ngÃ y nháº­n
    const range = groupRanges.find(r => dayCount >= r.min && dayCount <= r.max)?.label || "æœªçŸ¥";
    if (!summary[range]) summary[range] = { RWT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 }, MIT: { å®Œæˆ: 0, æœªå®Œæˆ: 0 } };
    if (category === "RWT") {
      summary[range].RWT[progress === 100 ? "å®Œæˆ" : "æœªå®Œæˆ"]++;
    } else if (category === "MIT") {
      summary[range].MIT[progress === 100 ? "å®Œæˆ" : "æœªå®Œæˆ"]++;
    }

    const dayCell = row.cells[9];
    if (dayCell && dayCount) dayCell.firstChild.value = dayCount;
  });

  renderSummaryTable(summary);
  renderReasonTable(); // Hiá»ƒn thá»‹ báº£ng thá»‘ng kÃª
}
function renderSummaryTable(summary) {
  const container = document.getElementById("summaryTable");
  container.innerHTML = "";

  const table = document.createElement("table");
  const header = table.insertRow();
  header.innerHTML = `
    <th>åŒºé—´</th><th>RWT å®Œæˆ</th><th>RWT æœªå®Œæˆ</th>
    <th>MIT å®Œæˆ</th><th>MIT æœªå®Œæˆ</th>
  `;

  Object.entries(summary).forEach(([range, data]) => {
    const row = table.insertRow();
    row.innerHTML = `
      <td>${range}</td>
      <td>${data.RWT.å®Œæˆ}</td><td>${data.RWT.æœªå®Œæˆ}</td>
      <td>${data.MIT.å®Œæˆ}</td><td>${data.MIT.æœªå®Œæˆ}</td>
    `;
  });

  container.appendChild(table);
}
function renderReasonTable(data) {
  const rows = Array.from(document.querySelector("#detailTable tbody").rows);
  const reasonCount = {};

  rows.forEach(row => {
    const cells = Array.from(row.cells).map(c => c.firstChild?.value || "");
    const reason = cells[11]; // ç¬¬12åˆ—ï¼šåŸå› 
    const progress = parseInt(cells[8]) || 0;

    if (progress < 100 && reason.trim() !== "") {
      if (!reasonCount[reason]) reasonCount[reason] = 0;
      reasonCount[reason]++;
    }
  });

  let html = `<table><tr><th>æœªå®ŒæˆåŸå› </th><th>æ•°é‡</th></tr>`;
  Object.entries(reasonCount).forEach(([key, value]) => {
    html += `<tr><td>${key}</td><td>${value}</td></tr>`;
  });
  html += `</table>`;

  document.getElementById("reasonTable").innerHTML = html;
}
function calculateDayCount(receiveDate) {
  const today = new Date();
  const receiveDateObj = new Date(receiveDate);
  const diffTime = today - receiveDateObj;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}
window.onload = function () {
      fetch("https://script.google.com/macros/s/AKfycbxgafa_4zDxEPkcK98Inqse3Cu7O9MAKQQVwDPqwknrZdBqSfXshfapzg6DT1xmF-24zA/exec")  // Thay Ä‘á»•i URL theo script cá»§a báº¡n
        .then(response => response.json())  // Giáº£ sá»­ dá»¯ liá»‡u tráº£ vá» lÃ  JSON
        .then(data => {
          const tbody = document.querySelector("#detailTable tbody");

          // Kiá»ƒm tra dá»¯ liá»‡u tráº£ vá» cÃ³ Ä‘Ãºng Ä‘á»‹nh dáº¡ng hay khÃ´ng
          if (Array.isArray(data) && data.length > 1) {
            // Láº·p qua tá»«ng dÃ²ng dá»¯ liá»‡u (bá» qua tiÃªu Ä‘á»)
            data.slice(1).forEach(row => {
              const tr = tbody.insertRow();  // ThÃªm dÃ²ng má»›i vÃ o báº£ng
              row.forEach((val, i) => {
                const cell = tr.insertCell();  // ThÃªm Ã´ vÃ o dÃ²ng
                const input = document.createElement("input");  // Táº¡o Ã´ input
                input.type = i === 8 ? "number" : "text";  // Náº¿u lÃ  cá»™t 9 thÃ¬ lÃ  sá»‘
                input.value = val || "";  // GÃ¡n giÃ¡ trá»‹ vÃ o Ã´ input
                input.oninput = updateSummary;  // Cáº­p nháº­t tá»•ng há»£p khi thay Ä‘á»•i giÃ¡ trá»‹
                cell.appendChild(input);  // ThÃªm Ã´ input vÃ o Ã´ báº£ng
              });
            });

            updateSummary();  // Cáº­p nháº­t tá»•ng há»£p sau khi dá»¯ liá»‡u Ä‘Æ°á»£c thÃªm vÃ o
            renderReasonTable(data);  // Hiá»ƒn thá»‹ báº£ng lÃ½ do tá»« dá»¯ liá»‡u
          } else {
            console.error("Dá»¯ liá»‡u khÃ´ng há»£p lá»‡ hoáº·c khÃ´ng cÃ³");
          }
        })
        .catch(error => {
          console.error("Lá»—i khi láº¥y dá»¯ liá»‡u:", error);  // Xá»­ lÃ½ lá»—i náº¿u cÃ³
        });
    };
    function sendDataToGoogleSheets(data) {
  fetch("https://script.google.com/macros/s/AKfycbxgafa_4zDxEPkcK98Inqse3Cu7O9MAKQQVwDPqwknrZdBqSfXshfapzg6DT1xmF-24zA/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data)
  })
  .then(response => response.text())
  .then(result => console.log(result))
  .catch(error => console.error("Error:", error));
}
 </script>
 </body>
 </html>